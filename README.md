# Description

The purpose of this project is to utilize the ESPHome Undermount AC thermostat with the Undermount AC V3 system for integration with Home Assistant.

The design goals for this project are:

* Maximize occupant comfort by closely maintaining the set temperature.
* Minimize noise generated by the blower.
* Maximize system efficiency.

> Disclaimer: The software is provided "as is," without warranty of any kind, express or implied, including but not limited to warranties of merchantability, fitness for a particular purpose, and non-infringement. In no event shall the author be liable for any claim, damages, or other liability arising from the use of the software. This project is not associated with or endorsed by Undermount AC.

## Setup Instructions

User-friendly instructions to install ESPHome on an Undermount AC thermostat and for basic usage are available at:

ðŸ”— [https://anthonysecco.github.io/undermount-ac-esphome-thermostat/](https://anthonysecco.github.io/undermount-ac-esphome-thermostat/)

# Technical Details

This section provides a brief technical overview of the thermostat.

At its core, this thermostat utilizes the Climate component in ESPHome, a temperature probe, and four high-side switching terminals. The terminals are:

* Blower Speed (PWM @ 240Hz, 0â€“100%)
* Blower Power (On/Off)
* Compressor On (On/Off)
* Compressor High (On/Off)

Additional scripts add enhanced functionality:

* PID Control Loop â€“ For automatic blower speed control
* Compressor Control â€“ For automatic high-speed compressor control
* Status Light â€“ Updates the onboard RGB LED
* Blower Ramp Control â€“ Gradually adjusts blower speed over 10 seconds

## Blower Constraints

The Undermount V3 system uses a brushless DC blower. Speed is controlled via a PWM signal line at 240Hz, with a duty cycle range of 10% to 98%. Below 10%, the blower fails to turn over. Above 98% is avoided to protect the driver. In practice, duty cycles above 80% do not further increase max speed.

### Speed Steps

Although the manufacturer could not confirm it, testing shows the blower uses a linear speed step function. Speed changes occur approximately every 4% from 0â€“100%. Duty cycles near step boundaries can result in fluttering between stepsâ€”noticeable at low speeds. Some steps also produce pulsing or resonant noise.

To address this, a filtered array of clean, pleasant-sounding duty cycles was created. Speed percentages are mapped to the closest valid duty cycle in this array. Hysteresis is added to prevent frequent step switching. The result is smooth, stable blower operation.

### Evaporator Protection

The manufacturer recommends a minimum blower speed of 40% to prevent evaporator freezing during low-speed compressor operation. This avoids water accumulation and ice formation on the coils. Some users report freezing even at 40%. For high-speed compressor operation, 70% is the minimum recommended.

* Minimum blower speed in cooling mode: 40% (user-adjustable up to 60% in Home Assistant).
* Minimum in all other modes: 20%. Speeds below this cause unpleasant noise.

Raising the evaporator higher in the van reduces freezing risk by allowing hotter return air. Aim vents down and away to circulate warm air back to the blower.

## Compressor Constraints

The system's compressor supports three speeds, though only two are enabled at any timeâ€”typically Low and Medium. When high-speed is requested, the system will call either Medium or High based on the current configuration.

To avoid pressure imbalances, which are common in refrigeration systems when rapidly changing compressor states, minimum off and idle timers are configured in the Climate component. Compressor speed changes also have a 2-minute activation delay for protection and stability.

## PID Control

In AUTO mode, a PID control loop runs at each update interval to calculate the appropriate blower speed. Only the Proportional (P) and Integral (I) terms are used.

PID control was chosen for its widespread use in systems where a constant target value is desired. The blower ramps up quickly when the temperature difference is large and slows down as the setpoint is approached. It also reacts to disturbances (e.g., door opening) to bring the temperature back to target.

> * The proportional constant is set so the blower reaches 100% at a +4.5Â°C temperature delta.
> * The integral constant is set so the blower reaches 100% if the setpoint isn't reached within 10 minutes.

To prevent integral wind-up, a clamp factor limits the I-term's contribution to no more than 1.5x the P-term's influence. This reduces cycling without compromising setpoint stability.

Constants and clamp factors can be adjusted in the YAML config. These values were tuned for a Ford Transit 148 Long Mid-Roof in California. Adjust in small increments (â‰¤10%) and allow a few days of testing to assess impact. The defaults should work for 90% of users.

### Cooling / Idle Cycle Management

Since the Undermount AC system uses discrete-speed (not variable-speed) compressors, even the lowest compressor and blower settings may overcool the van. Therefore, the system must cycle between cooling and idle.

The standard Climate component (not the PID variant) was selected to properly support hysteresis and required idle/off times.

* If the temperature drops more than 1Â°C below the setpoint, the system enters IDLE mode. The blower slows to 20% to purge residual cold air, then shuts off.
* If the temperature rises above 0.5Â°C below the setpoint, cooling resumes and the PID loop restarts.

> - Avoid running the idle fan longer than 30 seconds, as it pulls moisture into the cooled space. 30s balances air purging, evaporator drying, and moisture control.
> - A 20% blower speed in idle mode minimizes evaporator moisture draw.

## Blower Ramp Control

Ramp control ensures smooth, pleasant transitions in blower speed.

Speed commands are not applied directly. Instead, they pass through an interval script:

* The thermostat or PID loop sets a target speed and enables ramping.
* The ramp script calculates the difference between current and target speed.
* Every 200ms, it adjusts the speed incrementally until the target is reached.
* Once complete, it disables ramping.

Ramp speed is fixed: 0â€“100% in 10 seconds. Slower ramps cause audible step changes. The ramp engages on all speed changes, including on/off transitions.

## Compressor Speed Control

The compressor supports two selectable modes:

* Low
* Medium or High (default: Medium)

> Refer to the manufacturer for switching instructions. Most users will find Medium sufficient.

A switch enables high-speed cooling. If blower speed exceeds 75% for 2 minutes, the high-speed terminal activates. It remains on until blower speed drops below 65% for 2 minutes.

This implements hysteresis around the 70% threshold recommended by the manufacturer. High-speed cooling is only used in Auto mode or when fan speed is manually set to High.

## Diagnostics

Several diagnostic sensors are included (some disabled by default). They report the status (on/off or duty cycle) of each terminal:

> * Blower Speed (PWM @ 240Hz, 0â€“100%)
> * Blower Power (On/Off)
> * Compressor On (On/Off)
> * Compressor High (On/Off)

Compressor lockout status can't be directly detected. However, if the compressor terminal is ON but no current is drawn (e.g., a few hundred watts), it's likely in lockout.

> Note: The blower speed represents actual terminal duty cycle. The fan component speed is relative to min/max values in the given mode. Expect differing values. The PID loop calculates the fan component speed.

# Contact

Please open an issue for bugs, feature requests, or general questions. Thanks!

â­ Star this project if you found it helpful.

## Contribution

> Special thanks to Mike from SmartyVan for the initial thermostat code. [View it here](https://github.com/mikegoubeaux/UndermountAC).

To contribute:

1. Fork the repository.
2. Create a new branch: `git checkout -b feature-name`
3. Make your changes and commit: `git commit -m 'Add feature'`
4. Push to the branch: `git push origin feature-name`
5. Submit a pull request.

# License

This project is licensed under the MIT License.
